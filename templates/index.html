<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EGX Auto Trading Bot</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root {
            --bg: #0a0a1a;
            --card: #131336;
            --accent: #00d4ff;
            --success: #00e676;
            --danger: #ff1744;
            --warn: #ffc107;
            --text: #eee;
            --text2: #8892b0
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at 20% 50%, rgba(0, 212, 255, 0.05), transparent 70%), radial-gradient(ellipse at 80% 50%, rgba(123, 44, 191, 0.05), transparent 70%);
            pointer-events: none;
            z-index: 0
        }

        .header {
            background: rgba(19, 19, 54, 0.85);
            backdrop-filter: blur(20px);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(0, 212, 255, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem
        }

        .logo-icon {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, #00d4ff, #7b2cbf);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3)
        }

        .logo h1 {
            font-size: 1.4rem;
            background: linear-gradient(135deg, #00d4ff, #a855f7);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap
        }

        .live-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: rgba(0, 230, 118, 0.1);
            border: 1px solid rgba(0, 230, 118, 0.3);
            border-radius: 20px;
            font-size: 0.85rem
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 1.5s infinite
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(0, 230, 118, 0.5)
            }

            50% {
                box-shadow: 0 0 0 6px transparent
            }
        }

        .main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
            position: relative;
            z-index: 1
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem
        }

        .stat-card {
            background: var(--card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.06);
            position: relative;
            overflow: hidden
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            border-radius: 0 16px 16px 0
        }

        .stat-card.blue::after {
            background: var(--accent)
        }

        .stat-card.green::after {
            background: var(--success)
        }

        .stat-card.red::after {
            background: var(--danger)
        }

        .stat-card.yellow::after {
            background: var(--warn)
        }

        .stat-val {
            font-size: 1.8rem;
            font-weight: 900;
            line-height: 1.2
        }

        .stat-label {
            color: var(--text2);
            font-size: 0.85rem;
            margin-top: 4px
        }

        .positive {
            color: var(--success)
        }

        .negative {
            color: var(--danger)
        }

        .section {
            margin-bottom: 2.5rem
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem
        }

        .section-header h2 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1rem
        }

        .card {
            background: var(--card);
            border-radius: 14px;
            padding: 1.25rem;
            border: 1px solid rgba(255, 255, 255, 0.06);
            transition: transform 0.2s
        }

        .trade-card {
            border-right: 4px solid var(--success)
        }

        .trade-card.loss {
            border-right-color: var(--danger)
        }

        .trade-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem
        }

        .ticker {
            font-size: 1.15rem;
            font-weight: 700
        }

        .ticker-sub {
            font-size: 0.78rem;
            color: var(--text2)
        }

        .badge {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600
        }

        .badge.open {
            background: rgba(0, 212, 255, 0.15);
            color: var(--accent)
        }

        .badge.profit {
            background: rgba(0, 230, 118, 0.15);
            color: var(--success)
        }

        .badge.loss {
            background: rgba(255, 23, 68, 0.15);
            color: var(--danger)
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            font-size: 0.83rem
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 9px;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 7px
        }

        .info-item .lbl {
            color: var(--text2)
        }

        .pnl-box {
            text-align: center;
            margin-top: 0.6rem;
            padding: 0.6rem;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1.2rem
        }

        .pnl-box.positive {
            background: rgba(0, 230, 118, 0.1);
            color: var(--success)
        }

        .pnl-box.negative {
            background: rgba(255, 23, 68, 0.1);
            color: var(--danger)
        }

        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-size: 0.85rem;
            transition: all 0.2s
        }

        .btn:hover {
            opacity: 0.85
        }

        .btn-close {
            background: var(--danger);
            color: white;
            width: 100%;
            margin-top: 0.6rem
        }

        .settings-panel {
            background: var(--card);
            border: 1px solid rgba(0, 212, 255, 0.15);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem
        }

        .settings-panel h3 {
            color: var(--accent);
            margin-bottom: 1.25rem;
            font-size: 1.1rem
        }

        .setting-row {
            margin-bottom: 1.25rem
        }

        .setting-row label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.9rem
        }

        .setting-row input[type="range"] {
            width: 100%;
            accent-color: var(--accent);
            height: 6px
        }

        .setting-row input[type="number"] {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-family: inherit
        }

        .toggle-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            margin-bottom: 1rem
        }

        .toggle {
            width: 52px;
            height: 28px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
            flex-shrink: 0
        }

        .toggle.on {
            background: var(--success)
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s
        }

        .toggle.on::after {
            left: 26px
        }

        .btn-save {
            background: linear-gradient(135deg, #00d4ff, #7b2cbf);
            color: white;
            width: 100%;
            padding: 12px
        }

        .btn-reset {
            background: rgba(255, 23, 68, 0.15);
            color: var(--danger);
            border: 1px solid rgba(255, 23, 68, 0.3);
            width: 100%;
            padding: 12px;
            margin-top: 1rem
        }

        select {
            width: 100%;
            padding: 10px;
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-family: inherit;
            margin-bottom: 1rem
        }

        .empty {
            text-align: center;
            padding: 2.5rem;
            color: var(--text2);
            font-size: 0.95rem
        }

        .log-line {
            font-size: 0.78rem;
            color: var(--text2);
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03)
        }

        .log-line.trade {
            color: var(--success)
        }

        .log-line.close {
            color: var(--danger)
        }

        .log-line.info {
            color: var(--accent)
        }

        #activity-log {
            max-height: 250px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem
        }

        #chart-container {
            min-height: 400px
        }

        .last-update {
            color: var(--text2);
            font-size: 0.8rem
        }

        .trade-time {
            font-size: 0.75rem;
            color: var(--text2);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 4px
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">ğŸ¤–</div>
            <div>
                <h1>EGX Auto Trading</h1><small style="color:var(--text2)">ØªØ¯Ø§ÙˆÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ</small>
            </div>
        </div>
        <div class="header-info">
            <div class="live-badge">
                <div class="live-dot"></div><span id="conn">Ù…ØªØµÙ„</span>
            </div>
            <span class="last-update" id="last-update">-</span>
        </div>
    </header>

    <main class="main">
        <!-- Stats -->
        <div class="stats">
            <div class="stat-card blue">
                <div class="stat-val" id="equity">-</div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆÙ„ (Ø¬.Ù…)</div>
            </div>
            <div class="stat-card green">
                <div class="stat-val" id="pnl">-</div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</div>
            </div>
            <div class="stat-card yellow">
                <div class="stat-val" id="winrate">-</div>
                <div class="stat-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</div>
            </div>
            <div class="stat-card red">
                <div class="stat-val" id="open-n">-</div>
                <div class="stat-label">Ù…ÙØªÙˆØ­Ø© / Ù…ØºÙ„Ù‚Ø©</div>
            </div>
        </div>

        <!-- Settings -->
        <div class="settings-panel">
            <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</h3>
            <div class="toggle-row">
                <div class="toggle on" id="auto-toggle" onclick="toggleAuto()"></div>
                <div><strong id="auto-label">Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…ÙØ¹Ù„</strong><br><small style="color:var(--text2)">ÙŠÙØªØ­
                        ØµÙÙ‚Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª</small></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem">
                <div class="setting-row">
                    <label><span>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©</span><span id="conf-v">65%</span></label>
                    <input type="range" id="conf-r" min="50" max="90" value="65" step="5"
                        oninput="document.getElementById('conf-v').textContent=this.value+'%'">
                </div>
                <div class="setting-row">
                    <label><span>Ø£Ù‚ØµÙ‰ Ø¹Ø¯Ø¯ ØµÙÙ‚Ø§Øª</span><span id="max-v">100</span></label>
                    <input type="range" id="max-r" min="5" max="100" value="100" step="5"
                        oninput="document.getElementById('max-v').textContent=this.value">
                </div>
                <div class="setting-row">
                    <label>Ù…Ø¨Ù„Øº ÙƒÙ„ ØµÙÙ‚Ø© (Ø¬.Ù…)</label>
                    <input type="number" id="amt-i" value="1000" min="100" step="100">
                </div>
            </div>
            <button class="btn btn-save" onclick="saveSettings()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>

        <!-- Open Trades -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ“Š Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© (<span id="open-count">0</span>)</h2>
                <span class="last-update" id="trades-time">-</span>
            </div>
            <div id="trades-grid" class="grid">
                <div class="empty">â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø£ÙˆÙ„ Ù…Ø³Ø­...</div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</h2>
            </div>
            <div id="activity-log">
                <div class="log-line info">ğŸš€ Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„...</div>
            </div>
        </div>

        <!-- Chart -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ“ˆ ØªØ­Ù„ÙŠÙ„ Ø³Ù‡Ù…</h2>
            </div>
            <select id="stock-select" onchange="loadChart()">
                <option value="">Ø§Ø®ØªØ± Ø³Ù‡Ù… Ù„Ù„ØªØ­Ù„ÙŠÙ„...</option>
            </select>
            <div id="chart-container" class="card">
                <div class="empty">Ø§Ø®ØªØ± Ø³Ù‡Ù…</div>
            </div>
        </div>

        <!-- Closed Trades -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ“œ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ØºÙ„Ù‚Ø© (<span id="closed-count">0</span>)</h2>
            </div>
            <div id="closed-grid" class="grid">
                <div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ù…ØºÙ„Ù‚Ø©</div>
            </div>
        </div>

        <!-- Reset -->
        <div class="section" style="max-width:400px">
            <button class="btn btn-reset" onclick="doReset()">âš ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙˆØ­Ø°Ù ÙƒÙ„ Ø§Ù„ØµÙÙ‚Ø§Øª</button>
        </div>
    </main>

    <script>
        const socket = io();
        let settings = { auto_trade_enabled: true };

        // Format date for display
        function fmtTime(isoStr) {
            if (!isoStr) return '-';
            const d = new Date(isoStr);
            const day = d.toLocaleDateString('ar-EG', { day: 'numeric', month: 'short' });
            const time = d.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
            return day + ' ' + time;
        }
        function nowTime() { return new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', second: '2-digit' }); }

        // === Socket Events ===
        socket.on('connect', () => { setConn(true); addLog('info', 'âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„'); loadAll(); });
        socket.on('disconnect', () => { setConn(false); addLog('info', 'âŒ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„'); });
        socket.on('trades_update', data => { renderTrades(data.trades); renderPortfolio(data.portfolio); setTime(); });
        socket.on('new_trade', data => {
            const t = data.trade;
            addLog('trade', 'ğŸŸ¢ ØµÙÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø©: ' + (t.arabic_name || t.ticker) + ' @ ' + t.entry_price + ' (' + t.signal_confidence + '%)');
            loadAll();
        });

        function setConn(ok) {
            document.getElementById('conn').textContent = ok ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„';
            document.querySelector('.live-dot').style.background = ok ? 'var(--success)' : 'var(--danger)';
        }
        function setTime() {
            const t = nowTime();
            document.getElementById('last-update').textContent = 'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' + t;
            document.getElementById('trades-time').textContent = t;
        }
        function addLog(type, msg) {
            const log = document.getElementById('activity-log');
            const el = document.createElement('div');
            el.className = 'log-line ' + type;
            el.textContent = nowTime() + ' â€” ' + msg;
            log.insertBefore(el, log.firstChild);
            while (log.children.length > 80) log.removeChild(log.lastChild);
        }

        // === Data Loading ===
        async function loadAll() { loadSettings(); loadPortfolio(); loadTrades(); loadClosed(); loadCompanies(); }

        async function loadSettings() {
            try {
                const d = (await (await fetch('/api/settings')).json()).settings;
                settings = d;
                document.getElementById('conf-r').value = d.min_confidence;
                document.getElementById('conf-v').textContent = d.min_confidence + '%';
                document.getElementById('max-r').value = d.max_open_trades;
                document.getElementById('max-v').textContent = d.max_open_trades;
                document.getElementById('amt-i').value = d.trade_amount;
                document.getElementById('auto-toggle').classList.toggle('on', d.auto_trade_enabled);
                document.getElementById('auto-label').textContent = d.auto_trade_enabled ? 'Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…ÙØ¹Ù„' : 'Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¹Ø·Ù„';
            } catch (e) { console.error('loadSettings', e); }
        }

        async function loadPortfolio() {
            try {
                const d = (await (await fetch('/api/trades/portfolio')).json()).portfolio;
                renderPortfolio(d);
            } catch (e) { console.error('loadPortfolio', e); }
        }

        function renderPortfolio(p) {
            if (!p) return;
            document.getElementById('equity').textContent = Number(p.total_equity).toLocaleString('ar-EG');
            const pnlEl = document.getElementById('pnl');
            pnlEl.textContent = (p.total_pnl >= 0 ? '+' : '') + Number(p.total_pnl).toLocaleString('ar-EG');
            pnlEl.className = 'stat-val ' + (p.total_pnl >= 0 ? 'positive' : 'negative');
            document.getElementById('winrate').textContent = p.win_rate + '%';
            document.getElementById('open-n').textContent = p.open_trades + ' / ' + p.closed_trades;
        }

        async function loadTrades() {
            try {
                const d = await (await fetch('/api/trades/open')).json();
                renderTrades(d.trades);
            } catch (e) { console.error('loadTrades', e); }
        }

        function renderTrades(trades) {
            if (!trades) return;
            const el = document.getElementById('trades-grid');
            document.getElementById('open-count').textContent = trades.length;
            if (!trades.length) { el.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ù…ÙØªÙˆØ­Ø© â€” Ø§Ù„Ø¨ÙˆØª ÙŠØ¨Ø­Ø« ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚</div>'; return; }
            el.innerHTML = trades.map(t => `
            <div class="card trade-card ${t.pnl < 0 ? 'loss' : ''}">
                <div class="trade-header">
                    <div><div class="ticker">${t.arabic_name || t.ticker.replace('.CA', '')}</div><div class="ticker-sub">${t.ticker} Â· Ù‚ÙˆØ© ${t.signal_confidence}%</div></div>
                    <span class="badge open">Ù…ÙØªÙˆØ­Ø©</span>
                </div>
                <div class="trade-time">ğŸ• ${fmtTime(t.entry_time)} Â· ${t.id}</div>
                <div class="info-grid">
                    <div class="info-item"><span class="lbl">Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„</span><span>${t.entry_price}</span></div>
                    <div class="info-item"><span class="lbl">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</span><span style="font-weight:700">${t.current_price}</span></div>
                    <div class="info-item"><span class="lbl">ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©</span><span class="negative">${t.stop_loss}</span></div>
                    <div class="info-item"><span class="lbl">Ø¬Ù†ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</span><span class="positive">${t.take_profit}</span></div>
                    <div class="info-item"><span class="lbl">Ø§Ù„ÙƒÙ…ÙŠØ©</span><span>${t.quantity}</span></div>
                    <div class="info-item"><span class="lbl">Ø§Ù„Ù…Ø¨Ù„Øº</span><span>${t.investment_amount} Ø¬.Ù…</span></div>
                </div>
                <div class="pnl-box ${t.pnl >= 0 ? 'positive' : 'negative'}">${t.pnl >= 0 ? '+' : ''}${Number(t.pnl).toFixed(2)} Ø¬.Ù… (${t.pnl_percent}%)</div>
                <button class="btn btn-close" onclick="doClose('${t.ticker}')">Ø¥ØºÙ„Ø§Ù‚ ÙŠØ¯ÙˆÙŠ</button>
            </div>
        `).join('');
            setTime();
        }

        async function loadClosed() {
            try {
                const d = await (await fetch('/api/trades?type=closed')).json();
                const el = document.getElementById('closed-grid');
                document.getElementById('closed-count').textContent = d.trades.length;
                if (!d.trades.length) { el.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ù…ØºÙ„Ù‚Ø© Ø¨Ø¹Ø¯</div>'; return; }
                el.innerHTML = d.trades.slice().reverse().slice(0, 30).map(t => `
                <div class="card trade-card ${t.pnl < 0 ? 'loss' : ''}">
                    <div class="trade-header">
                        <div><div class="ticker">${t.arabic_name || t.ticker.replace('.CA', '')}</div><div class="ticker-sub">${t.ticker}</div></div>
                        <span class="badge ${t.pnl >= 0 ? 'profit' : 'loss'}">${t.status}</span>
                    </div>
                    <div class="trade-time">ğŸ• Ø¯Ø®ÙˆÙ„: ${fmtTime(t.entry_time)} â†’ Ø®Ø±ÙˆØ¬: ${fmtTime(t.exit_time)}</div>
                    <div class="info-grid">
                        <div class="info-item"><span class="lbl">Ø§Ù„Ø¯Ø®ÙˆÙ„</span><span>${t.entry_price}</span></div>
                        <div class="info-item"><span class="lbl">Ø§Ù„Ø®Ø±ÙˆØ¬</span><span>${t.exit_price}</span></div>
                    </div>
                    <div class="pnl-box ${t.pnl >= 0 ? 'positive' : 'negative'}">${t.pnl >= 0 ? '+' : ''}${Number(t.pnl).toFixed(2)} Ø¬.Ù… (${t.pnl_percent}%)</div>
                </div>
            `).join('');
            } catch (e) { console.error('loadClosed', e); }
        }

        async function loadCompanies() {
            try {
                const d = await (await fetch('/api/companies')).json();
                const sel = document.getElementById('stock-select');
                if (sel.children.length <= 1) {
                    sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø³Ù‡Ù…...</option>' + d.companies.map(c =>
                        `<option value="${c.ticker}">${c.arabic_name} (${c.ticker.replace('.CA', '')})</option>`
                    ).join('');
                }
            } catch (e) { }
        }

        async function loadChart() {
            const ticker = document.getElementById('stock-select').value;
            if (!ticker) return;
            document.getElementById('chart-container').innerHTML = '<div class="empty">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
            try {
                const d = await (await fetch('/api/chart/' + ticker)).json();
                if (d.chart) Plotly.newPlot('chart-container', d.chart.data, d.chart.layout, { responsive: true });
            } catch (e) { document.getElementById('chart-container').innerHTML = '<div class="empty">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>'; }
        }

        // === Trade Actions ===
        async function doClose(ticker) {
            if (!confirm('Ø¥ØºÙ„Ø§Ù‚ ØµÙÙ‚Ø© ' + ticker.replace('.CA', '') + 'ØŸ')) return;
            try {
                const res = await fetch('/api/trades/close/' + encodeURIComponent(ticker), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const d = await res.json();
                if (d.status === 'success') {
                    addLog('close', 'ğŸ”´ ØªÙ… Ø¥ØºÙ„Ø§Ù‚: ' + ticker + ' | PnL: ' + (d.trade ? d.trade.pnl : '?'));
                    loadAll();
                } else {
                    alert('Ø®Ø·Ø£: ' + (d.message || 'ÙØ´Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚'));
                }
            } catch (e) { alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + e.message); }
        }

        async function doReset() {
            if (!confirm('âš ï¸ Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„ØµÙÙ‚Ø§Øª ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ! Ù…ØªØ£ÙƒØ¯ØŸ')) return;
            if (!confirm('ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ - Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ØŸ')) return;
            try {
                const res = await fetch('/api/trades/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const d = await res.json();
                if (d.status === 'success') {
                    addLog('info', 'ğŸ—‘ï¸ ' + (d.message || 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†'));
                    settings.auto_trade_enabled = false;
                    loadAll();
                    alert(d.message || 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†');
                } else {
                    alert('Ø®Ø·Ø£: ' + (d.message || 'ÙØ´Ù„'));
                }
            } catch (e) { alert('Ø®Ø·Ø£: ' + e.message); }
        }

        // === Settings ===
        function toggleAuto() {
            settings.auto_trade_enabled = !settings.auto_trade_enabled;
            saveSettings();
        }

        async function saveSettings() {
            try {
                const body = {
                    min_confidence: parseInt(document.getElementById('conf-r').value),
                    max_open_trades: parseInt(document.getElementById('max-r').value),
                    trade_amount: parseInt(document.getElementById('amt-i').value) || 1000,
                    auto_trade_enabled: settings.auto_trade_enabled
                };
                const res = await fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const d = await res.json();
                settings = d.settings;
                loadSettings();
                addLog('info', 'âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: Ù‚ÙˆØ©â‰¥' + d.settings.min_confidence + '% | Ø£Ù‚ØµÙ‰=' + d.settings.max_open_trades + ' | Ù…Ø¨Ù„Øº=' + d.settings.trade_amount);
            } catch (e) { alert('Ø®Ø·Ø£: ' + e.message); }
        }

        // Auto-refresh
        setInterval(() => { socket.emit('get_update'); }, 15000);
        setInterval(loadAll, 120000);

        if ('Notification' in window) Notification.requestPermission();
    </script>
</body>

</html>